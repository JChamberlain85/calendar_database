<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
        body { padding: 20px; font-family: sans-serif; }
        #calendar { max-width: 1100px; margin: 0 auto; }
        .toolbar { margin-bottom: 20px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <div class="toolbar">
        <h2>My Calendar ðŸ“…</h2>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#canvasModal">
            Import from Canvas (ICS)
        </button>
    </div>

    <div id='calendar'></div>
</div>

<div class="modal fade" id="canvasModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Subscribe to Canvas Feed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label>Canvas Calendar Feed URL (.ics)</label>
                    <input type="text" id="canvasUrl" class="form-control" placeholder="https://umsystem.instructure.com/feeds/calendars/user_....ics">
                    <small class="text-muted">
                        Find this link in Canvas > Calendar > "Calendar Feed" (bottom right).
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="importCanvas()">Import Events</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            selectable: true,
            editable: true,
            events: '/api/events', // Flask route to fetch events
            
            // Add Event Logic
            select: function(info) {
                var title = prompt('Enter Event Title:');
                if (title) {
                    fetch('/api/events', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            title: title,
                            start: info.startStr,
                            end: info.endStr
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        calendar.refetchEvents(); // Refresh calendar to show new event
                    });
                }
                calendar.unselect();
            },

            // Delete Event Logic
            eventClick: function(info) {
                if (confirm("Delete '" + info.event.title + "'?")) {
                    fetch('/api/events/' + info.event.id, {
                        method: 'DELETE'
                    })
                    .then(() => {
                        info.event.remove();
                    });
                }
            }
        });
        calendar.render();
    });

    function importCanvas() {
        const url = document.getElementById('canvasUrl').value;
        
        if(!url) { alert("Please paste the calendar feed URL"); return; }

        const btn = document.querySelector('#canvasModal .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = "Importing...";
        btn.disabled = true;

        fetch('/api/import-canvas', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url: url}) 
        })
        .then(res => res.json())
        .then(data => {
            if(data.error) {
                alert("Error: " + data.error);
            } else {
                alert("Success! Imported " + data.count + " new events.");
                location.reload(); // Refresh to show new events on the calendar
            }
        })
        .catch(err => alert("Network error"))
        .finally(() => {
            btn.innerText = originalText;
            btn.disabled = false;
        });
    }
</script>

</body>
</html>